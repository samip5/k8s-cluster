apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: lemmy
  namespace: federation
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: lemmy
  target:
    name: lemmy
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        config.hjson: |
          {
            database: {
              user: "{{.postgres_user}}"
              password: "{{.postgres_password}}"
              host: "federation-postgres-rw"
              port: 5432
              database: "lemmy"
              pool_size: 5
            }
            pictrs: {
              url: "http://pictrs.federation.svc.cluster.local:8080/"
              api_key: "{{.pictrs_api_key}}"
            }
            email: {
              smtp_server: "smtp-relay.default.svc.cluster.local:587"
              smtp_from_address: "lemmy-no-reply@skylab.fi"
              # Whether or not smtp connections should use tls. Can be none, tls, or starttls
              tls_type: "none"
            }
            setup: {
              admin_username: "kryptonian"
              admin_password: "{{.admin_password }}"
              site_name: "Skylab Lemmy"
              admin_email: "{{ .admin_email }}"
            }
            hostname: "lemmy.skylab.fi"
            port: 8536
            tls_enabled: true
          }
        PICTRS__API_KEY: '{{.pictrs_api_key}}'
        postgres-user: '{{.postgres_user}}'
        postgres-password: '{{.postgres_password}}'
  data:
    - secretKey: postgres_password
      remoteRef:
        key: POSTGRES_PASSWORD
    - secretKey: postgres_user
      remoteRef:
        key: POSTGRES_USER
    - secretKey: pictrs_api_key
      remoteRef:
        key: PICTRS_API_KEY
    - secretKey: admin_password
      remoteRef:
        key: ADMIN_PASSWORD
    - secretKey: admin_email
      remoteRef:
        key: ADMIN_EMAIL