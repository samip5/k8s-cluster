---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: lemmy-deploy
  namespace: federation
spec:
  sourceRef:
    kind: OCIRepository
    name: lemmy-ks
    namespace: federation
  interval: 10m
  prune: true
  wait: true
  targetNamespace: federation
  patches:
    - patch: |-
        - op: add
          path: /spec/template/spec/containers/0/env/-
          value:
            name: PICTRS__STORE__TYPE
            value: object_storage
        - op: add
          path: /spec/template/spec/containers/0/env/-
          value:
            name: PICTRS__STORE__USE_PATH_STYLE
            value: "true"
        - op: add
          path: /spec/template/spec/containers/0/env/-
          value:
            # Needs protocol can inject in args as well..
            name: PICTRS__STORE__ENDPOINT
            value: "https://s3.skym.fi"
        - op: add
          path: /spec/template/spec/containers/0/env/-
          value:
            name: PICTRS__STORE__BUCKET_NAME
            valueFrom:
              secretKeyRef:
                name: lemmy-bucket
                key: BUCKET_NAME
        - op: add
          path: /spec/template/spec/containers/0/env/-
          value:
            name: PICTRS__STORE__REGION
            valueFrom:
              secretKeyRef:
                name: lemmy-bucket
                key: BUCKET_REGION
        - op: add
          path: /spec/template/spec/containers/0/env/-
          value:
            name: PICTRS__STORE__ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: lemmy-bucket
                key: AWS_ACCESS_KEY_ID
        - op: add
          path: /spec/template/spec/containers/0/env/-
          value:
            name: PICTRS__STORE__SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: lemmy-bucket
                key: AWS_SECRET_ACCESS_KEY
      target:
        kind: Deployment
        name: pictrs
        version: v1
    - patch: |-
        - op: replace
          path: /spec/template/spec/containers/0/image
          value: ghcr.io/ubergeek77/lemmy:0.18.1-rc.9
        - op: add
          path: /spec/template/spec/initContainers
          value:
            - env:
              - name: INIT_POSTGRES_HOST
                value: federation-postgres-rw.federation.svc.cluster.local
              - name: INIT_POSTGRES_DBNAME
                value: lemmy
              - name: INIT_POSTGRES_SUPER_PASS
                valueFrom:
                  secretKeyRef:
                    key: password
                    name: postgres-superuser
              - name: INIT_POSTGRES_USER
                valueFrom:
                  secretKeyRef:
                    key: postgres-user
                    name: lemmy
              - name: INIT_POSTGRES_PASS
                valueFrom:
                  secretKeyRef:
                    key: postgres-password
                    name: lemmy
              image: ghcr.io/onedr0p/postgres-init:14.8@sha256:dfddde81c0d49da09da1e893c95c32934333baba60edde707be5010dc3baa4c2
              imagePullPolicy: IfNotPresent
              name: init-db
      target:
        kind: Deployment
        name: lemmy
        version: v1
    - patch: |-
        - op: replace
          path: /spec/rules/0/host
          value: lemmy.skylab.fi
        - op: replace
          path: /spec/tls/0/hosts/0
          value: lemmy.skylab.fi
        - op: add
          path: /metadata/annotations
          value:
            cert-manager.io/cluster-issuer: zerossl-production
        - op: add
          path: /spec/ingressClassName
          value: nginx

      target:
        kind: Ingress
        name: lemmy
        version: v1
    - patch: |-
        - op: replace
          path: /spec/template/spec/containers/0/env/0/value
          value: lemmy.skylab.fi
        - op: replace
          path: /spec/template/spec/containers/0/image
          value: ghcr.io/ubergeek77/lemmy-ui:0.18.1-rc.9
      target:
        kind: Deployment
        name: lemmy-ui
        version: v1