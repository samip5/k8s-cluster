---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: dendrite
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://bjw-s.github.io/helm-charts
      chart: app-template
      version: 1.3.2
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  install:
    createNamespace: true
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  dependsOn:
    - name: csi-driver-nfs
      namespace: storage
  values:
    image:
      repository: ghcr.io/matrix-org/dendrite-monolith
      #repository: ghcr.io/samip5/dendrite-monolith
      #tag: loginsso@sha256:13a6ab9c23f8fb111b128499b070c8b5bfbaf95df4487626ec0ca66fd8ae6005
      tag: v0.11.1
      pullPolicy: IfNotPresent
    strategy:
      type: Recreate
    service:
      main:
        ports:
          http:
            port: 8008
          https:
            enabled: true
            port: 8448
            protocol: HTTPS
    ingress:
      main:
        enabled: true
        ingressClassName: nginx
        annotations:
          cert-manager.io/cluster-issuer: zerossl-production
          external-dns.home.arpa/enabled: "true"
          nginx.ingress.kubernetes.io/default-backend: "dendrite"
        hosts:
          - host: d.skylab.fi
            paths:
              - path: /
                pathType: Prefix
              - path: /.well-known/matrix/server
                pathType: Prefix
              - path: /.well-known/matrix/client
                pathType: Prefix
          - host: skylab.fi
            paths:
              - path: /.well-known/matrix/
                pathType: Prefix
              - path: /.well-known/matrix/server
                pathType: Prefix
              - path: /.well-known/matrix/client
                pathType: Prefix
        tls:
          - secretName: dendrite-cert
            hosts:
              - d.skylab.fi
    secrets:
      yaml:
        enabled: true
        stringData:
          dendrite.yaml: |
            version: 2
            global:
              server_name: "skylab.fi"
              private_key: matrix_key.pem
              key_validity_period: "168h0m0s"
              cache:
                max_size_estimated: "1gb"
                max_age: "1h"
              well_known_server_name: "d.skylab.fi:443"
              well_known_client_name: "https://d.skylab.fi:443"
              trusted_third_party_id_servers:
                - matrix.org
                - vector.im
              disable_federation: false
              presence:
                enable_inbound: true
                enable_outbound: true
              report_stats:
                enabled: true
                endpoint: https://matrix.org/report-usage-stats/push
              server_notices:
                enabled: false
                local_part: "_server"
                display_name: "Server alerts"
                avatar_url: ""
                room_name: "Server Alerts"
              jetstream:
                addresses:
                  []
                in_memory: false
                storage_path: /jetstream
                topic_prefix: "Dendrite"
              metrics:
                enabled: false
                basic_auth:
                  username: "metrics"
                  password: "metrics"
              dns_cache:
                enabled: false
                cache_size: 256
                cache_lifetime: 5m
              database:
                connection_string: ${SECRET_DENDRITE_DB_CONNECTION_STRING}
                max_open_conns: 30
                max_idle_conns: 2
                conn_max_lifetime: -1
            app_service_api:
              config_files:
                []
            client_api:
              login:
                sso:
                 enabled: true
                 providers:
                   - id: id.skylab.fi
                     name: Skylab SSO
                     type: oidc
                     oidc:
                      client_id: a6ae6d5e71260fa262cab88c7dc80d2014e22515
                      client_secret: ${SECRET_DENDRITE_CLIENT_SECRET}
                      discovery_url: https://id.skylab.fi/application/o/dendrite/.well-known/openid-configuration
              registration_disabled: true
              registration_shared_secret: "${SECRET_DENDRITE_REGISTRATION_SECRET}"
              enable_registration_captcha: true
              recaptcha_public_key: "${SECRET_DENDRITE_RECA_PUB_KEY}"
              recaptcha_private_key: "${SECRET_DENDRITE_RECA_PRIV_KEY}"
              recaptcha_bypass_secret: ""
              recaptcha_siteverify_api: "https://www.google.com/recaptcha/api/siteverify"
              turn:
                turn_password: ""
                turn_shared_secret: ""
                turn_uris: []
                turn_user_lifetime: ""
                turn_username: ""
              rate_limiting:
                enabled: true
                threshold: 5
                cooloff_ms: 500
                exempt_user_ids: 
            federation_api:
              send_max_retries: 16
              disable_tls_validation: false
              key_perspectives:
                - keys:
                  - key_id: ed25519:auto
                    public_key: Noi6WqcDj0QmPxCNQqgezwTlBKrfqehY1u2FyWP9uYw
                  - key_id: ed25519:a_RXGa
                    public_key: l8Hft5qXKn1vfHrg3p4+W8gELQVo8N13JkluMfmn2sQ
                  server_name: matrix.org
              prefer_direct_fetch: false
            key_server:
            media_api:
              base_path: "/media"
              max_file_size_bytes: 10485760
              dynamic_thumbnails: true
              max_thumbnail_generators: 10
              thumbnail_sizes:
                - height: 32
                  method: crop
                  width: 32
                - height: 96
                  method: crop
                  width: 96
                - height: 480
                  method: scale
                  width: 640
            mscs:
              mscs:
                - msc2836
                - msc2946
                - msc2444
                - msc2753
            room_server:
            sync_api:
              search:
                enabled: true
                index_path: "/search"
                language: "fi"
            user_api:
              bcrypt_cost: 10
            tracing:
              enabled: false
              jaeger:
                baggage_restrictions: null
                disabled: false
                headers: null
                reporter: null
                rpc_metrics: false
                sampler: null
                serviceName: ""
                tags: []
                throttler: null
            logging:
              - level: info
                params:
                  path: /var/dendrite-log
                type: file
    persistence:
      logs:
        enabled: true
        mountPath: /var/dendrite-log
        type: emptyDir
      media:
        enabled: true
        existingClaim: dendrite-media-pvc
      search:
        enabled: true
        existingClaim: dendrite-search-pvc
      jetstream:
        enabled: true
        existingClaim: dendrite-jetstream-pvc
      matrix-key:
        enabled: true
        type: secret
        name: dendrite-matrix-key
        mountPath: "/etc/dendrite/matrix_key.pem"
        subPath: "matrix_key.pem"
        defaultMode: 0600
      dendrite-config:
        enabled: true
        type: secret
        name: dendrite-yaml
        mountPath: "/etc/dendrite/dendrite.yaml"
        subPath: "dendrite.yaml"
    podAnnotations:
      configmap.reloader.stakater.com/reload: "dendrite-config"
    podSecurityContext:
      fsGroup: 1337
    probes:
      liveness:
        enabled: true
        custom: true
        spec:
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 10
          httpGet:
            path: /_dendrite/monitor/health
            port: http
      readiness:
        enabled: true
        custom: true
        spec:
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 10
          httpGet:
            path: /_dendrite/monitor/health
            port: http
      startup:
        enabled: true
        custom: true
        spec:
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 10
          httpGet:
            path: /_dendrite/monitor/up
            port: http
