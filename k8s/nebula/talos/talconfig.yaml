---
clusterName: nebula
# renovate: depName=ghcr.io/siderolabs/installer datasource=docker
talosVersion: v1.9.1
# renovate: depName=ghcr.io/siderolabs/kubelet datasource=docker
kubernetesVersion: v1.30.2

cniConfig:
  name: none

endpoint: https://10.0.105.10:6443
domain: nebula.local
allowSchedulingOnMasters: true
additionalMachineCertSans:
  - "127.0.0.1"
  - "10.0.105.34"
additionalApiServerCertSans:
  - nebula.local
  - cluster.local
clusterPodNets:
  - 10.244.0.0/16
  - fddf:f7bc:9670::/48
clusterSvcNets:
  - 10.96.0.0/12
  - 2001:14ba:74ae:3405::1e:0/112


nodes:
  - hostname: m1
    ipAddress: 10.0.105.34
    controlPlane: true
    installDisk: /dev/sda
    schematic: &amd-schematic
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/i915
            - siderolabs/intel-ucode
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
    disableSearchDomain: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          interfaces:
            - enp0s31f6
        dhcp: true
        routes:
          - network: "::/0"
            gateway: "fd9d:7a72:44eb:c::1"
            metric: 1
        vlans:
          - vlanId: 50
            mtu: 1500
            addresses: [ "10.0.50.13/24" ]
            routes:
              - network: "10.0.50.0/24"
                gateway: "10.0.50.1"
                metric: 4097
        dhcpOptions:
          routeMetric: 4000
        vip:
          ip: 10.0.105.10
  - hostname: m2
    ipAddress: 10.0.105.30
    controlPlane: true
    installDiskSelector:
      size: ">=80GB"
    disableSearchDomain: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          interfaces:
            - enx0211322432e5
        dhcp: true
        routes:
          - network: "::/0"
            gateway: "fd9d:7a72:44eb:c::1"
            metric: 1
        dhcpOptions:
          routeMetric: 4000
        vip:
          ip: 10.0.105.10
  - hostname: w-amd-1
    ipAddress: 10.0.105.50
    controlPlane: false
    installDisk: /dev/sda
    schematic: *amd-schematic
    disableSearchDomain: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          interfaces:
            - enp0s31f6
        dhcp: true
        routes:
          - network: "::/0"
            gateway: "fd9d:7a72:44eb:c::1"
            metric: 1
        vlans:
          - vlanId: 50
            mtu: 1500
            addresses: [ "10.0.50.12/24" ]
            routes:
              - network: "10.0.50.0/24"
                gateway: "10.0.50.1"
                metric: 4097
        dhcpOptions:
          routeMetric: 4000
  - hostname: w-amd-2
    ipAddress: 10.0.105.28
    controlPlane: false
    installDiskSelector:
      size: "<= 300GB"
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/i915
            - siderolabs/intel-ucode
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
            - siderolabs/dvb-cx23885
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          interfaces:
           - enp2s0
        dhcp: true
        routes:
          - network: "::/0"
            gateway: "fd9d:7a72:44eb:c::1"
            metric: 1
        dhcpOptions:
          routeMetric: 4000
        vlans:
          - vlanId: 50
            mtu: 1500
            addresses: [ "10.0.50.10/24"]
            routes:
              - network: "10.0.50.0/24"
                gateway: "10.0.50.1"
                metric: 4097
          - vlanId: 99
            mtu: 1500
            addresses: [ "192.168.99.10/24" ]
            routes:
              - network: "192.168.99.0/24"
                gateway: "192.168.99.1"
                metric: 4096
  - hostname: w-amd-3
    ipAddress: 10.0.105.19
    controlPlane: false
    installDisk: /dev/sda
    schematic: *amd-schematic
    disableSearchDomain: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          interfaces:
            - eno1
        dhcp: true
        routes:
          - network: "::/0"
            gateway: "fd9d:7a72:44eb:c::1"
            metric: 1
        vlans:
          - vlanId: 50
            mtu: 1500
            addresses: [ "10.0.50.11/24" ]
            routes:
              - network: "10.0.50.0/24"
                gateway: "10.0.50.1"
                metric: 4097
        dhcpOptions:
          routeMetric: 4000
  - hostname: w7
    ipAddress: 10.0.105.29
    controlPlane: false
    installDiskSelector:
      wwid: naa.5002538f4173a3bc
    schematic:
      overlay:
        image: siderolabs/sbc-raspberrypi
        name: rpi_generic
    disableSearchDomain: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          interfaces:
            - enxd83addd870bc
        dhcp: true
        routes:
          - network: "::/0"
            gateway: "fd9d:7a72:44eb:c::1"
            metric: 1
        dhcpOptions:
          routeMetric: 4000
        vlans:
          - vlanId: 50
            mtu: 1500
            dhcp: true
            dhcpOptions:
              routeMetric: 4096
  - hostname: cm4-1
    ipAddress: 10.0.105.32
    installDiskSelector:
      size: '>=30GB'
    controlPlane: false
    schematic:
      overlay:
        image: siderolabs/sbc-raspberrypi
        name: rpi_generic
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          interfaces:
            - enxe45f012e06ac
        dhcp: true
        routes:
          - network: "::/0"
            gateway: "fd9d:7a72:44eb:d::1"
            metric: 1
        dhcpOptions:
          routeMetric: 4000


patches:
  - "@./patches/global/cluster-discovery.yaml"
  - "@./patches/global/containerd.yaml"
  - "@./patches/global/disable-search-domain.yaml"
  - "@./patches/global/kubelet.yaml"
  - "@./patches/global/nfs.yaml"
  - "@./patches/global/sysctl.yaml"
  - "@./patches/global/udev.yaml"
  - "@./patches/global/disable-kexec.yaml"
  - "@./patches/global/time.yaml"

controlPlane:
  patches:
    - "@./patches/controller/api-access.yaml"
    - "@./patches/controller/cluster.yaml"
    - "@./patches/controller/disable-admission-controller.yaml"
    - "@./patches/controller/kube-prism.yaml"


