---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: factorio
  namespace: games
spec:
  chart:
    spec:
      chart: factorio-server-charts
      version: 2.2.1
      sourceRef:
        kind: HelmRepository
        name: factorio
        namespace: flux-system
  interval: 1h0m0s
  valuesFrom:
    - kind: Secret
      name: factorio-secret
  values:
    nodeSelector:
      beta.kubernetes.io/arch: amd64
    image:
      pullPolicy: Always
      tag: "stable"
    persistence:
      enabled: true
      dataDir:
        Size: "${VOLSYNC_CAPACITY}"
        existingClaim: "factorio"
    service:
      type: LoadBalancer
      port: 34197
    mods:
      enabled: true
      portal:
        - squeak-through-2
        # - factorio-prometheus-exporter
        - factoryplanner
        - flib
    port_fixer:
      enabled: true
      port: 34197
    factorioServer:
      save_name: "default-save"
      update_mods_on_start: true
      load_latest_save: true
      enable_space_age: true
    # https://github.com/SQLJames/factorio-server-charts/pull/49
    map_settings:
      asteroids:
        spawning_rate: 1
        max_ray_portals_expanded_per_tick: 100
    server_settings:
      name: Kryptonian's game
      description: "dedicated server on Kubernetes ;)"
      max_players: 0
      visibility:
        public: true
        lan: true
      require_user_verification: true
      max_upload_in_kilobytes_per_second: 0
      max_upload_slots: 10
      autosave_interval: 5
      autosave_slots: 10
      minimum_latency_in_ticks: 0
      ignore_player_limit_for_returning_players: true
      allow_commands: admins-only
      auto_pause: true
      only_admins_can_pause_the_game: true
      non_blocking_saving: true # Highly experimental
    admin_list: [kryptonian98]